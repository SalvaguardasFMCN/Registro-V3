<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Registro de Asistencia</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link rel="stylesheet"
        href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">

  <style>
    body { padding: 20px; }
    .list-group-item { cursor: pointer; }
  </style>
</head>
<body>

<div class="container">
  <h3>Registro de Asistencia</h3>
  <hr>

  <!-- EVENTO -->
  <div class="form-group">
    <label>ID de la Actividad</label>
    <input type="text" id="event-id" class="form-control" placeholder="EVT-001">
  </div>

  <div class="form-group">
    <label>Nombre de la Actividad</label>
    <input type="text" id="event-name" class="form-control" placeholder="Nombre del evento">
  </div>

  <hr>

  <!-- BUSCADOR -->
  <h5>Búsqueda de Persona</h5>

  <input type="text"
         id="search-person"
         class="form-control"
         placeholder="Buscar por nombre o apellido">

  <div id="person-results" class="list-group mt-3"></div>

  <div id="loading" class="mt-3" style="display:none;">
    <div class="spinner-border"></div>
  </div>

  <div id="results" class="alert mt-3" style="display:none;"></div>
</div>

<script>
const WEB_APP_URL = "https://script.google.com/macros/s/AKfycby4QbBzIcF7t1P4PbD7JpyeET5HNALR1tHX_dV_2MhcA3aTERl1QHE_iUpxNsQajqkbpQ/exec";

let debounce;

function showLoading(v) {
  document.getElementById('loading').style.display = v ? 'block' : 'none';
}

function showResult(msg, error = false) {
  const r = document.getElementById('results');
  r.className = error ? 'alert alert-danger' : 'alert alert-success';
  r.textContent = msg;
  r.style.display = 'block';
  setTimeout(() => r.style.display = 'none', 4000);
}

async function callApi(action, data) {
  const res = await fetch(WEB_APP_URL, {
    method: 'POST',
    mode: 'cors',
    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
    body: JSON.stringify({ action, data })
  });

  const json = await res.json();
  if (json.status === 'error') throw new Error(json.message);
  return json.data;
}

/* =====================================
   BUSCADOR
===================================== */

document.getElementById('search-person').addEventListener('input', e => {
  const value = e.target.value.trim();
  if (value.length < 3) return;

  clearTimeout(debounce);
  debounce = setTimeout(() => searchPersons(value), 300);
});

async function searchPersons(query) {
  showLoading(true);
  try {
    const persons = await callApi('searchPersons', { query });
    renderResults(persons);
  } catch (e) {
    showResult(e.message, true);
  } finally {
    showLoading(false);
  }
}

function renderResults(list) {
  const container = document.getElementById('person-results');
  container.innerHTML = '';

  if (list.length === 0) {
    container.innerHTML = '<div class="text-muted">Sin resultados</div>';
    return;
  }

  list.forEach(p => {
    const item = document.createElement('button');
    item.className = 'list-group-item list-group-item-action';
    item.textContent =
      `${p.nombre} ${p.apellido1} ${p.apellido2 || ''} — ${p.extra || ''}`;

    item.onclick = () => register(p.id);
    container.appendChild(item);
  });
}

/* =====================================
   REGISTRO
===================================== */

async function register(personId) {
  const eventId = document.getElementById('event-id').value;
  const eventName = document.getElementById('event-name').value;

  if (!eventId || !eventName) {
    showResult('Debes indicar la actividad', true);
    return;
  }

  showLoading(true);
  try {
    const msg = await callApi('validateUserAndEvent', {
      userIdentifier: { id: personId },
      eventIdentifier: { id: eventId, nombre: eventName },
      method: 'Busqueda-Nombre'
    });
    showResult(msg);
  } catch (e) {
    showResult(e.message, true);
  } finally {
    showLoading(false);
  }
}
</script>

</body>
</html>
